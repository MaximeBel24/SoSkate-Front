<div class="form-container">
  <!-- Header -->
  <div class="form-header">
    <h2 class="form-title">
      {{ serviceId() ? "Modifier" : "Cr√©er" }} une prestation
    </h2>
    <p class="form-subtitle">
      {{ serviceId() ? "Mettez √† jour les informations de la prestation" : "Ajoutez une nouvelle prestation de skateboard" }}
    </p>
  </div>

  <!-- Form -->
  <form [formGroup]="serviceForm" (ngSubmit)="submit()" class="form-body">
    <!-- Section: Informations g√©n√©rales -->
    <div class="form-section">
      <h3 class="section-title">
        <app-icon-info [size]="20" />
        Informations g√©n√©rales
      </h3>

      <div class="form-grid">
        <!-- Nom -->
        <div class="form-group full-width">
          <label for="name" class="form-label">
            Nom de la prestation <span class="required">*</span>
          </label>
          <input
            formControlName="name"
            id="name"
            type="text"
            class="form-input"
            placeholder="Ex: Cours Solo, Coaching Priv√©, Location Compl√®te..."
            [class.input-error]="serviceForm.get('name')?.invalid && serviceForm.get('name')?.touched"
          />
          @if (serviceForm.get('name')?.invalid && serviceForm.get('name')?.touched) {
            <span class="error-message">Le nom est requis (3-100 caract√®res)</span>
          }
        </div>

        <!-- Type de service -->
        <div class="form-group full-width">
          <label for="type" class="form-label">
            Type de prestation <span class="required">*</span>
          </label>
          <select
            formControlName="type"
            id="type"
            class="form-select"
            [class.input-error]="serviceForm.get('type')?.invalid && serviceForm.get('type')?.touched"
          >
            <option [ngValue]="null" disabled>S√©lectionnez un type</option>
            @for (serviceType of serviceTypes; track serviceType.value) {
              <option [ngValue]="serviceType.value">
                {{ serviceType.icon }} {{ serviceType.label }}
              </option>
            }
          </select>
          @if (serviceForm.get('type')?.invalid && serviceForm.get('type')?.touched) {
            <span class="error-message">Le type de prestation est requis</span>
          }
        </div>

        <!-- Description -->
        <div class="form-group full-width">
          <label for="description" class="form-label">
            Description <span class="required">*</span>
          </label>
          <textarea
            formControlName="description"
            id="description"
            rows="5"
            class="form-input form-textarea"
            placeholder="D√©crivez la prestation: nombre de personnes, niveau requis, √©quipement inclus, particularit√©s..."
            [class.input-error]="serviceForm.get('description')?.invalid && serviceForm.get('description')?.touched"
          ></textarea>
          @if (serviceForm.get('description')?.invalid && serviceForm.get('description')?.touched) {
            <span class="error-message">La description est requise (10-1000 caract√®res)</span>
          }
        </div>
      </div>

      <!-- Info card dynamique selon le type -->
      @if (serviceForm.get('type')?.value) {
        <div class="type-badge-container">
          <div class="type-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @switch (serviceForm.get('type')?.value) {
                @case ('LESSON') {
                  <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                  <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                }
                @case ('PRIVATE_COACHING') {
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                }
                @case ('RENTAL') {
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                }
                @case ('SUBSCRIPTION') {
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                }
                @case ('EVENT') {
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                  <path d="M8 14h.01"/>
                  <path d="M12 14h.01"/>
                  <path d="M16 14h.01"/>
                  <path d="M8 18h.01"/>
                  <path d="M12 18h.01"/>
                  <path d="M16 18h.01"/>
                }
              }
            </svg>
            @if (serviceForm.get('type')?.value !== null && serviceForm.get('type')?.value !== undefined) {
              <span>{{ getServiceTypeLabel(serviceForm.get('type')?.value!) }}</span>
            }
          </div>
        </div>
      }
    </div>

    <!-- Section: Tarification et dur√©e -->
    <div class="form-section">
      <h3 class="section-title">
        <app-icon-dollar [size]="20" />
        Tarification et dur√©e
      </h3>

      <div class="form-grid">
        <!-- Dur√©e en minutes -->
        <div class="form-group">
          <label for="durationMinutes" class="form-label">
            Dur√©e (en minutes) <span class="required">*</span>
          </label>
          <div class="input-with-addon">
            <input
              formControlName="durationMinutes"
              id="durationMinutes"
              type="number"
              min="0"
              step="15"
              class="form-input"
              placeholder="Ex: 60"
              [class.input-error]="serviceForm.get('durationMinutes')?.invalid && serviceForm.get('durationMinutes')?.touched"
            />
            <span class="input-addon">min</span>
          </div>
          @if (serviceForm.get('durationMinutes')?.invalid && serviceForm.get('durationMinutes')?.touched) {
            <span class="error-message">La dur√©e est requise</span>
          }
          @if (serviceForm.get('durationMinutes')?.value != null && serviceForm.get('durationMinutes')?.value! > 0) {
            <span class="help-text">
              ‚è±Ô∏è Dur√©e: {{ serviceForm.get('durationMinutes')?.value | duration }}
            </span>
          }
        </div>

        <!-- Prix en centimes -->
        <div class="form-group">
          <label for="basePriceCents" class="form-label">
            Prix de base (en centimes) <span class="required">*</span>
          </label>
          <div class="input-with-addon">
            <span class="input-addon-left">¬¢</span>
            <input
              formControlName="basePriceCents"
              id="basePriceCents"
              type="number"
              min="0"
              step="100"
              class="form-input input-with-left-addon"
              placeholder="Ex: 5000"
              [class.input-error]="serviceForm.get('basePriceCents')?.invalid && serviceForm.get('basePriceCents')?.touched"
            />
          </div>
          @if (serviceForm.get('basePriceCents')?.invalid && serviceForm.get('basePriceCents')?.touched) {
            <span class="error-message">Le prix est requis</span>
          }
          @if (serviceForm.get('basePriceCents')?.value !== null && serviceForm.get('basePriceCents')?.value !== undefined && serviceForm.get('basePriceCents')?.value! >= 0) {
            <span class="help-text">
              üí∞ Prix affich√©: {{ serviceForm.get('basePriceCents')?.value | price }}
            </span>
          }
        </div>

        <!-- Boutons de prix rapides -->
        <div class="form-group full-width">
          <label class="form-label">Prix rapides</label>
          <div class="quick-buttons">
            @for (quickPrice of quickPrices; track quickPrice.cents) {
              <button
                type="button"
                class="quick-btn"
                [class.active]="serviceForm.get('basePriceCents')?.value === quickPrice.cents"
                (click)="setQuickPrice(quickPrice.cents)"
              >
                {{ quickPrice.label }}
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Card r√©capitulatif -->
      @if (serviceForm.get('basePriceCents')?.value !== null && serviceForm.get('durationMinutes')?.value) {
        <div class="summary-card summary-success">
          <div class="summary-item">
            <span class="summary-label">Prix total</span>
            <span class="summary-value">{{ serviceForm.get('basePriceCents')?.value | price }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Prix/heure</span>
            <span class="summary-value">{{ calculatePricePerHour() | price }}/h</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Dur√©e totale</span>
            <span class="summary-value">{{ serviceForm.get('durationMinutes')?.value | duration }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Section: Disponibilit√© -->
    <div class="form-section">
      <h3 class="section-title">
        <app-icon-activity [size]="20" />
        Disponibilit√©
      </h3>

      <div class="form-grid">
        <!-- Statut -->
        <div class="form-group">
          <label for="isActive" class="form-label">
            Statut de publication <span class="required">*</span>
          </label>
          <select
            formControlName="isActive"
            id="isActive"
            class="form-select"
            [class.input-error]="serviceForm.get('isActive')?.invalid && serviceForm.get('isActive')?.touched"
          >
            <option [ngValue]="null" disabled>S√©lectionnez un statut</option>
            <option [ngValue]="true">‚úÖ Actif (visible et r√©servable)</option>
            <option [ngValue]="false">‚ùå Inactif (masqu√©)</option>
          </select>
          @if (serviceForm.get('isActive')?.invalid && serviceForm.get('isActive')?.touched) {
            <span class="error-message">Le statut est requis</span>
          }
        </div>
      </div>

      <!-- Status cards -->
      <div class="info-cards">
        <div
          class="info-card"
          [class.info-card-active]="serviceForm.get('isActive')?.value === true"
        >
          <app-icon-check-circle [size]="24" />
          <div>
            <h4>Prestation Active</h4>
            <p>Visible sur l'application mobile, les utilisateurs peuvent la r√©server</p>
          </div>
        </div>

        <div
          class="info-card"
          [class.info-card-active]="serviceForm.get('isActive')?.value === false"
        >
          <app-icon-ban [size]="24" />
          <div>
            <h4>Prestation Inactive</h4>
            <p>Masqu√©e aux utilisateurs, non disponible √† la r√©servation</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        [routerLink]="['..', 'list']"
        [disabled]="isLoading()"
      >
        <app-icon-arrow-left [size]="18" />
        Annuler
      </button>

      <button
        type="submit"
        class="btn btn-premium"
        [disabled]="serviceForm.invalid || isLoading()"
      >
        @if (isLoading()) {
          <span class="spinner"></span>
          <span>Enregistrement...</span>
        } @else {
          <app-icon-check [size]="18" />
          <span>{{ serviceId() ? "Mettre √† jour" : "Cr√©er la prestation" }}</span>
        }
      </button>
    </div>

    <!-- Form validation summary -->
    @if (serviceForm.invalid && serviceForm.touched) {
      <div class="validation-summary">
        <app-icon-alert-circle [size]="18" />
        <span>Veuillez corriger les erreurs avant de soumettre le formulaire</span>
      </div>
    }
  </form>
</div>

<app-confirmation-modal
  [isOpen]="updateModal.isOpen"
  [type]="'update'"
  [title]="'Confirmer la mise √† jour'"
  [message]="'√ätes-vous s√ªr de vouloir enregistrer les modifications apport√©es √† cette prestation ?'"
  [confirmText]="'Mettre √† jour'"
  [cancelText]="'Annuler'"
  [isLoading]="updateModal.isLoading"
  (confirm)="confirmUpdate()"
  (cancel)="closeUpdateModal()"
  (close)="closeUpdateModal()"
/>
