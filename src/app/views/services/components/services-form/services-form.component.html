<div class="form-container">
  <!-- Header -->
  <app-form-header
    [title]="serviceId() ? 'Modifier une prestation' : 'Créer une prestation'"
    [subtitle]="serviceId() ? 'Mettez à jour les informations de la prestation' : 'Ajoutez une nouvelle prestation de skateboard'"
  />

  <!-- Form -->
  <form [formGroup]="serviceForm" (ngSubmit)="submit()" class="form-body">

    <!-- Section: Informations générales -->
    <app-form-section title="Informations générales">
      <ng-template #icon>
        <app-icon-info [size]="20" />
      </ng-template>

      <div class="form-grid">
        <!-- Nom -->
        <app-form-input
          label="Nom de la prestation"
          inputId="name"
          formControlName="name"
          placeholder="Ex: Cours Solo, Coaching Privé, Location Complète..."
          [required]="true"
          [fullWidth]="true"
          [hasError]="serviceForm.get('name')?.invalid ?? false"
          [touched]="serviceForm.get('name')?.touched ?? false"
          errorMessage="Le nom est requis (3-100 caractères)"
        />

        <!-- Type de service -->
        <app-form-select
          label="Type de prestation"
          selectId="type"
          formControlName="type"
          [options]="serviceTypeOptions"
          placeholder="Sélectionnez un type"
          [required]="true"
          [fullWidth]="true"
          [hasError]="serviceForm.get('type')?.invalid ?? false"
          [touched]="serviceForm.get('type')?.touched ?? false"
          errorMessage="Le type de prestation est requis"
        />

        <!-- Description -->
        <app-form-textarea
          label="Description"
          textareaId="description"
          formControlName="description"
          placeholder="Décrivez la prestation: nombre de personnes, niveau requis, équipement inclus, particularités..."
          [rows]="5"
          [required]="true"
          [hasError]="serviceForm.get('description')?.invalid ?? false"
          [touched]="serviceForm.get('description')?.touched ?? false"
          errorMessage="La description est requise (10-1000 caractères)"
        />
      </div>

      <!-- Info card dynamique selon le type -->
      @if (serviceForm.get('type')?.value) {
        <div class="type-badge-container">
          <div class="type-badge">
            <ng-container [ngSwitch]="serviceForm.get('type')?.value">
<!--              <app-icon-graduation *ngSwitchCase="'LESSON'" [size]="20" />-->
<!--              <app-icon-users *ngSwitchCase="'PRIVATE_COACHING'" [size]="20" />-->
<!--              <app-icon-lock *ngSwitchCase="'RENTAL'" [size]="20" />-->
<!--              <app-icon-calendar *ngSwitchCase="'SUBSCRIPTION'" [size]="20" />-->
<!--              <app-icon-calendar *ngSwitchCase="'EVENT'" [size]="20" />-->
            </ng-container>
            <span>{{ getServiceTypeLabel(serviceForm.get('type')?.value!) }}</span>
          </div>
        </div>
      }
    </app-form-section>

    <!-- Section: Tarification et durée -->
    <app-form-section title="Tarification et durée">
      <ng-template #icon>
        <app-icon-dollar [size]="20" />
      </ng-template>

      <div class="form-grid">
        <!-- Durée en minutes -->
        <app-form-input
          label="Durée (en minutes)"
          inputId="durationMinutes"
          type="number"
          formControlName="durationMinutes"
          placeholder="Ex: 60"
          min="0"
          step="15"
          addon="min"
          [required]="true"
          [hasError]="serviceForm.get('durationMinutes')?.invalid ?? false"
          [touched]="serviceForm.get('durationMinutes')?.touched ?? false"
          errorMessage="La durée est requise"
          [helpText]="getDurationHelpText()"
        />

        <!-- Prix en centimes -->
        <app-form-input
          label="Prix de base (en centimes)"
          inputId="basePriceCents"
          type="number"
          formControlName="basePriceCents"
          placeholder="Ex: 5000"
          min="0"
          step="100"
          addonLeft="¢"
          [required]="true"
          [hasError]="serviceForm.get('basePriceCents')?.invalid ?? false"
          [touched]="serviceForm.get('basePriceCents')?.touched ?? false"
          errorMessage="Le prix est requis"
          [helpText]="getPriceHelpText()"
        />

        <!-- Boutons de prix rapides -->
        <div class="form-group full-width">
          <label class="form-label">Prix rapides</label>
          <div class="quick-buttons">
            @for (quickPrice of quickPrices; track quickPrice.cents) {
              <button
                type="button"
                class="quick-btn"
                [class.active]="serviceForm.get('basePriceCents')?.value === quickPrice.cents"
                (click)="setQuickPrice(quickPrice.cents)"
              >
                {{ quickPrice.label }}
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Card récapitulatif -->
      @if (serviceForm.get('basePriceCents')?.value !== null && serviceForm.get('durationMinutes')?.value) {
        <div class="summary-card summary-success">
          <div class="summary-item">
            <span class="summary-label">Prix total</span>
            <span class="summary-value">{{ serviceForm.get('basePriceCents')?.value | price }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Prix/heure</span>
            <span class="summary-value">{{ calculatePricePerHour() | price }}/h</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Durée totale</span>
            <span class="summary-value">{{ serviceForm.get('durationMinutes')?.value | duration }}</span>
          </div>
        </div>
      }
    </app-form-section>

    <!-- Section: Disponibilité -->
    <app-form-section title="Disponibilité">
      <ng-template #icon>
        <app-icon-activity [size]="20" />
      </ng-template>

      <div class="form-grid">
        <!-- Statut -->
        <app-form-select
          label="Statut de publication"
          selectId="isActive"
          formControlName="isActive"
          [options]="statusOptions"
          placeholder="Sélectionnez un statut"
          [required]="true"
          [hasError]="serviceForm.get('isActive')?.invalid ?? false"
          [touched]="serviceForm.get('isActive')?.touched ?? false"
          errorMessage="Le statut est requis"
        />
      </div>

      <!-- Status cards -->
      <div class="info-cards">
        <app-info-card
          title="Prestation Active"
          description="Visible sur l'application mobile, les utilisateurs peuvent la réserver"
          [isActive]="serviceForm.get('isActive')?.value === true"
        >
          <ng-template #icon>
            <app-icon-check-circle [size]="24" />
          </ng-template>
        </app-info-card>

        <app-info-card
          title="Prestation Inactive"
          description="Masquée aux utilisateurs, non disponible à la réservation"
          [isActive]="serviceForm.get('isActive')?.value === false"
        >
          <ng-template #icon>
            <app-icon-ban [size]="24" />
          </ng-template>
        </app-info-card>
      </div>
    </app-form-section>

    <!-- Form Actions -->
    <app-form-actions
      [cancelLink]="['..', 'list']"
      [submitText]="serviceId() ? 'Mettre à jour' : 'Créer la prestation'"
      [isLoading]="isLoading()"
      [isInvalid]="serviceForm.invalid"
    />

    <!-- Validation Summary -->
    <app-validation-summary
      [isInvalid]="serviceForm.invalid"
      [isTouched]="serviceForm.touched"
    />
  </form>
</div>

<app-confirmation-modal
  [isOpen]="updateModal.isOpen"
  [type]="'update'"
  [title]="'Confirmer la mise à jour'"
  [message]="'Êtes-vous sûr de vouloir enregistrer les modifications apportées à cette prestation ?'"
  [confirmText]="'Mettre à jour'"
  [cancelText]="'Annuler'"
  [isLoading]="updateModal.isLoading"
  (confirm)="confirmUpdate()"
  (cancel)="closeUpdateModal()"
  (close)="closeUpdateModal()"
/>
